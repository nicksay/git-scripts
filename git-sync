#!/bin/bash
#
# Sync the current branch: pull and rebase from upstream and push to fork
#
# $1 = upstream (defaults to upstream from `git get-fork-and-upstream`)
# $2 = fork (defaults to fork from `git get-fork-and-upstream`)
# $3 = branch (defaults to the current branch)

set -e  # stop on error

SCRIPTS="$(dirname "$0")"

upstream=${1:-$("$SCRIPTS"/git-get-fork-and-upstream | awk '/upstream:/ { print $2 }')}
fork=${2:-$("$SCRIPTS"/git-get-fork-and-upstream | awk '/fork:/ { print $2 }')}
current=$(git symbolic-ref --short HEAD)
branch=${3:-$current}


echo "Pulling latest commits from $upstream/$branch to $current..."
echo "> git pull --prune --tags $upstream $branch"
git pull --prune --tags $upstream $branch
echo "Done."

if [[ "$upstream" != "$fork" ]]; then
  echo "Pushing $current to $fork/$branch..."
  echo "> git push --prune $fork $current:$branch"
  git push --prune $fork $current:$branch
  echo "Done."
fi
